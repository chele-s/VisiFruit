#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
üöÄ DEMO INTERACTIVA - Control Motor DC con Relays 12V
===================================================

Demo simple y directa para controlar motor DC usando 2 relays de 12V
con Raspberry Pi 5. Ideal para pruebas r√°pidas y demostraci√≥n.

Autor(es): Gabriel Calder√≥n, Elias Bautista, Cristian Hernandez
Fecha: Julio 2025
Versi√≥n: 1.0 - Demo Edition
"""

import asyncio
import logging
import time
import signal
import sys
from pathlib import Path

# Agregar directorio padre para importaciones
sys.path.append(str(Path(__file__).parent.parent))

try:
    # Intentar primero el controlador Pi5 (lgpio)
    from Control_Etiquetado.relay_motor_controller_pi5 import create_relay_motor_driver_pi5
    RELAY_MODULE_AVAILABLE = True
    USE_PI5_DRIVER = True
    print("üîß Usando controlador Pi5 con lgpio")
except ImportError:
    try:
        # Fallback al controlador original (RPi.GPIO)
        from Control_Etiquetado.relay_motor_controller import create_relay_motor_driver
        RELAY_MODULE_AVAILABLE = True
        USE_PI5_DRIVER = False
        print("üîß Usando controlador original con RPi.GPIO")
    except ImportError as e:
        print(f"‚ö†Ô∏è M√≥dulo de relays no disponible: {e}")
        RELAY_MODULE_AVAILABLE = False
        USE_PI5_DRIVER = False

# Configuraci√≥n de logging simple
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    datefmt='%H:%M:%S'
)

logger = logging.getLogger(__name__)

class DemoRelayMotor:
    """Demo interactiva para control de motor con relays."""
    
    def __init__(self):
        self.driver = None
        self.running = False
        self.demo_active = True
        
        # Configuraci√≥n de pines (puedes cambiarlos aqu√≠)
        self.RELAY1_PIN = 18  # GPIO 18 - Adelante
        self.RELAY2_PIN = 19  # GPIO 19 - Atr√°s  
        self.ENABLE_PIN = 26  # GPIO 26 - Habilitaci√≥n (opcional)
        
    async def initialize_demo(self):
        """Inicializar la demo."""
        print("\n" + "="*60)
        print("üöÄ DEMO: Control Motor DC con Relays 12V")
        print("="*60)
        print(f"üìå Configuraci√≥n de pines:")
        print(f"   ‚Ä¢ Relay 1 (Adelante): GPIO {self.RELAY1_PIN}")
        print(f"   ‚Ä¢ Relay 2 (Atr√°s):    GPIO {self.RELAY2_PIN}")
        print(f"   ‚Ä¢ Habilitaci√≥n:       GPIO {self.ENABLE_PIN}")
        print("\nüîå Aseg√∫rate de que las conexiones est√©n correctas antes de continuar.")
        
        if not RELAY_MODULE_AVAILABLE:
            print("‚ùå M√≥dulo de relays no disponible - Modo simulaci√≥n")
            return False
        
        try:
            # Crear driver con configuraci√≥n simple
            if USE_PI5_DRIVER:
                self.driver = create_relay_motor_driver_pi5(
                    relay1_pin=self.RELAY1_PIN,
                    relay2_pin=self.RELAY2_PIN, 
                    enable_pin=self.ENABLE_PIN
                )
                print("‚úÖ Usando driver optimizado para Raspberry Pi 5")
            else:
                self.driver = create_relay_motor_driver(
                    relay1_pin=self.RELAY1_PIN,
                    relay2_pin=self.RELAY2_PIN, 
                    enable_pin=self.ENABLE_PIN
                )
                print("‚ö†Ô∏è Usando driver legacy (puede no funcionar en Pi 5)")
            
            # Inicializar
            if await self.driver.initialize():
                print("‚úÖ Driver de relays inicializado correctamente")
                
                # Mostrar estado inicial
                status = await self.driver.get_status()
                print(f"üìä Estado inicial:")
                print(f"   ‚Ä¢ Relay 1: {status['relay_states']['relay1']}")
                print(f"   ‚Ä¢ Relay 2: {status['relay_states']['relay2']}")
                print(f"   ‚Ä¢ Motor:   {'Funcionando' if status['running'] else 'Parado'}")
                
                return True
            else:
                print("‚ùå Error inicializando driver de relays")
                return False
                
        except Exception as e:
            print(f"‚ùå Error en inicializaci√≥n: {e}")
            return False
    
    async def demo_manual_control(self):
        """Demo de control manual interactivo."""
        print("\n" + "="*50)
        print("üéÆ CONTROL MANUAL DEL MOTOR")
        print("="*50)
        print("Comandos disponibles:")
        print("  [A] - Motor ADELANTE")
        print("  [S] - Motor ATR√ÅS") 
        print("  [P] - PARAR motor")
        print("  [E] - EMERGENCIA")
        print("  [I] - Ver INFO")
        print("  [Q] - Salir")
        print("\nüí° Escribe el comando y presiona Enter...")
        
        while self.demo_active:
            try:
                command = input("\nüéØ Comando: ").strip().upper()
                
                if command == 'A':
                    await self._motor_adelante()
                elif command == 'S':
                    await self._motor_atras()
                elif command == 'P':
                    await self._motor_parar()
                elif command == 'E':
                    await self._motor_emergencia()
                elif command == 'I':
                    await self._mostrar_info()
                elif command == 'Q':
                    print("üëã Saliendo del control manual...")
                    await self._motor_parar()
                    break
                else:
                    print("‚ùì Comando no reconocido. Usa A, S, P, E, I o Q")
                    
            except KeyboardInterrupt:
                print("\n‚ö†Ô∏è Ctrl+C detectado - Parando motor...")
                await self._motor_emergencia()
                break
            except Exception as e:
                print(f"‚ùå Error: {e}")
    
    async def _motor_adelante(self):
        """Mover motor hacia adelante."""
        print("‚è© Iniciando motor ADELANTE...")
        try:
            if await self.driver.start_belt():
                self.running = True
                print("‚úÖ Motor funcionando hacia ADELANTE")
                await self._mostrar_estado_relays()
            else:
                print("‚ùå Error iniciando motor")
        except Exception as e:
            print(f"‚ùå Error: {e}")
    
    async def _motor_atras(self):
        """Mover motor hacia atr√°s."""
        print("‚è™ Cambiando motor hacia ATR√ÅS...")
        try:
            if await self.driver.reverse_direction():
                self.running = True
                print("‚úÖ Motor funcionando hacia ATR√ÅS")
                await self._mostrar_estado_relays()
            else:
                print("‚ùå Error cambiando direcci√≥n")
        except Exception as e:
            print(f"‚ùå Error: {e}")
    
    async def _motor_parar(self):
        """Parar motor."""
        print("‚èπÔ∏è Parando motor...")
        try:
            if await self.driver.stop_belt():
                self.running = False
                print("‚úÖ Motor PARADO")
                await self._mostrar_estado_relays()
            else:
                print("‚ùå Error parando motor")
        except Exception as e:
            print(f"‚ùå Error: {e}")
    
    async def _motor_emergencia(self):
        """Parada de emergencia."""
        print("üö® PARADA DE EMERGENCIA...")
        try:
            if await self.driver.emergency_brake():
                self.running = False
                print("‚úÖ Parada de emergencia ejecutada")
                await self._mostrar_estado_relays()
            else:
                print("‚ùå Error en parada de emergencia")
        except Exception as e:
            print(f"‚ùå Error: {e}")
    
    async def _mostrar_estado_relays(self):
        """Mostrar estado actual de los relays."""
        try:
            status = await self.driver.get_status()
            relay1 = status['relay_states']['relay1']
            relay2 = status['relay_states']['relay2']
            direction = status['direction']
            
            print(f"   üîÑ Relay 1: {relay1}")
            print(f"   üîÑ Relay 2: {relay2}")
            print(f"   ‚û°Ô∏è Direcci√≥n: {direction}")
        except Exception as e:
            print(f"‚ùå Error obteniendo estado: {e}")
    
    async def _mostrar_info(self):
        """Mostrar informaci√≥n completa del sistema."""
        print("\nüìä INFORMACI√ìN DEL SISTEMA")
        print("-" * 40)
        try:
            status = await self.driver.get_status()
            
            print(f"üîß Estado general:")
            print(f"   ‚Ä¢ Inicializado: {status['initialized']}")
            print(f"   ‚Ä¢ Motor funcionando: {status['running']}")
            print(f"   ‚Ä¢ Direcci√≥n actual: {status['direction']}")
            print(f"   ‚Ä¢ Tipo control: {status['control_type']}")
            
            print(f"\nüîÑ Estado de relays:")
            print(f"   ‚Ä¢ Relay 1 (Adelante): {status['relay_states']['relay1']}")
            print(f"   ‚Ä¢ Relay 2 (Atr√°s): {status['relay_states']['relay2']}")
            
            print(f"\nüìå Configuraci√≥n de pines:")
            pins = status['pins']
            print(f"   ‚Ä¢ Relay 1: GPIO {pins['relay1_forward']}")
            print(f"   ‚Ä¢ Relay 2: GPIO {pins['relay2_backward']}")
            if pins['enable']:
                print(f"   ‚Ä¢ Enable: GPIO {pins['enable']}")
            
            if status.get('safety_timeout_active'):
                print(f"\n‚è∞ Timeout de seguridad: ACTIVO")
                
        except Exception as e:
            print(f"‚ùå Error obteniendo informaci√≥n: {e}")
    
    async def demo_automatica(self):
        """Demo autom√°tica con secuencia predefinida."""
        print("\n" + "="*50)
        print("ü§ñ DEMO AUTOM√ÅTICA")
        print("="*50)
        print("Ejecutando secuencia autom√°tica de pruebas...")
        
        secuencia = [
            ("Iniciando motor hacia adelante...", "adelante", 3),
            ("Parando motor...", "parar", 1),
            ("Iniciando motor hacia atr√°s...", "atras", 3),
            ("Parando motor...", "parar", 1),
            ("Probando cambio r√°pido de direcci√≥n...", "cambio_rapido", 4),
            ("Parada final...", "parar", 1)
        ]
        
        for descripcion, accion, duracion in secuencia:
            print(f"\nüîÑ {descripcion}")
            
            try:
                if accion == "adelante":
                    await self.driver.start_belt()
                elif accion == "atras":
                    await self.driver.reverse_direction()
                elif accion == "parar":
                    await self.driver.stop_belt()
                elif accion == "cambio_rapido":
                    await self.driver.start_belt()
                    await asyncio.sleep(1)
                    await self.driver.reverse_direction()
                    await asyncio.sleep(1)
                    await self.driver.start_belt()
                
                # Mostrar estado
                await self._mostrar_estado_relays()
                
                # Esperar duraci√≥n especificada
                print(f"   ‚è±Ô∏è Esperando {duracion} segundos...")
                await asyncio.sleep(duracion)
                
            except Exception as e:
                print(f"‚ùå Error en paso autom√°tico: {e}")
                break
        
        print("\n‚úÖ Demo autom√°tica completada")
    
    async def demo_seguridad(self):
        """Demo de caracter√≠sticas de seguridad."""
        print("\n" + "="*50)
        print("üõ°Ô∏è DEMO DE SEGURIDAD")
        print("="*50)
        
        # Test 1: Timeout autom√°tico
        print("\nüî¨ Test 1: Timeout de seguridad")
        print("   Configurando timeout corto (3 segundos)...")
        
        # Guardar timeout original
        timeout_original = self.driver.config.safety_timeout_s
        self.driver.config.safety_timeout_s = 3.0
        
        print("   Iniciando motor... deber√≠a parar autom√°ticamente")
        await self.driver.start_belt()
        
        # Esperar m√°s del timeout
        for i in range(4):
            await asyncio.sleep(1)
            status = await self.driver.get_status()
            print(f"   Segundo {i+1}: Motor {'ON' if status['running'] else 'OFF'}")
        
        # Restaurar timeout
        self.driver.config.safety_timeout_s = timeout_original
        print("   ‚úÖ Test de timeout completado")
        
        # Test 2: Delay entre cambios
        print("\nüî¨ Test 2: Delay entre cambios de direcci√≥n")
        start_time = time.time()
        await self.driver.start_belt()
        await self.driver.reverse_direction()
        end_time = time.time()
        
        delay = end_time - start_time
        print(f"   Tiempo de cambio: {delay:.3f} segundos")
        print(f"   Delay m√≠nimo: {self.driver._direction_change_delay} segundos")
        print(f"   ‚úÖ {'Correcto' if delay >= self.driver._direction_change_delay else 'Advertencia'}")
        
        await self.driver.stop_belt()
    
    async def cleanup_demo(self):
        """Limpiar recursos de la demo."""
        if self.driver:
            try:
                print("\nüßπ Limpiando recursos...")
                await self.driver.stop_belt()
                await self.driver.cleanup()
                print("‚úÖ Limpieza completada")
            except Exception as e:
                print(f"‚ö†Ô∏è Error en limpieza: {e}")

async def main():
    """Funci√≥n principal de la demo."""
    demo = DemoRelayMotor()
    
    # Configurar manejador de se√±ales para limpieza
    def signal_handler(signum, frame):
        print(f"\nüõë Se√±al {signum} recibida - Terminando demo...")
        demo.demo_active = False
    
    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)
    
    try:
        # Mostrar informaci√≥n inicial
        print("üéØ Demo de Control de Motor DC con Relays 12V")
        print("üîß Raspberry Pi 5 + M√≥dulo Relays 2 Canales")
        print("\n‚ö†Ô∏è  IMPORTANTE: Verifica las conexiones antes de continuar")
        
        input("\nüìã Presiona Enter para continuar...")
        
        # Inicializar demo
        if not await demo.initialize_demo():
            print("‚ùå No se pudo inicializar la demo")
            return
        
        # Men√∫ principal
        while demo.demo_active:
            print("\n" + "="*50)
            print("üéÆ MEN√ö PRINCIPAL")
            print("="*50)
            print("1. üéÆ Control manual interactivo")
            print("2. ü§ñ Demo autom√°tica")
            print("3. üõ°Ô∏è Demo de seguridad")
            print("4. üìä Ver informaci√≥n del sistema")
            print("0. üö™ Salir")
            
            try:
                opcion = input("\nüéØ Selecciona una opci√≥n: ").strip()
                
                if opcion == "1":
                    await demo.demo_manual_control()
                elif opcion == "2":
                    await demo.demo_automatica()
                elif opcion == "3":
                    await demo.demo_seguridad()
                elif opcion == "4":
                    await demo._mostrar_info()
                elif opcion == "0":
                    print("üëã Saliendo de la demo...")
                    break
                else:
                    print("‚ùì Opci√≥n no v√°lida")
                    
            except KeyboardInterrupt:
                print("\n‚ö†Ô∏è Interrupci√≥n detectada - Saliendo...")
                break
            except Exception as e:
                print(f"‚ùå Error: {e}")
    
    except Exception as e:
        print(f"üí• Error fatal en demo: {e}")
    
    finally:
        await demo.cleanup_demo()
        print("\nüëã Demo terminada. ¬°Gracias por probar el sistema!")

if __name__ == "__main__":
    print("\nüöÄ Iniciando Demo de Relays...")
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\nüõë Demo interrumpida por usuario")
    except Exception as e:
        print(f"üí• Error fatal: {e}")
        import traceback
        traceback.print_exc()
